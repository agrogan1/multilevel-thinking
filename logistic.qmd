# Multilevel Logistic Regression

> "We have peered into a new world and have seen that it is more mysterious and more complex than we had imagined." [@Rubin1997]

## Introduction

New forms of the multilevel model are required when we have outcomes that are not continuous. Let us imagine, for example, that we have a situation in which our continuous outcome is now categorized into two groups. For example, we might imagine that there is some sort of diagnostic cutoff. scores greater than this cutoff are assigned to one group (`1`), while scores lower than the cutoff are assigned to another group (`0`). 

No doubt this scenario is more likely when we consider an *undesirable* outcome like depression or anxiety. Higher levels of depression or anxiety might be greater than some diagnostic cutoff, meriting a score of `1`, *meets criteria for a diagnosis*, while scores lower than that diagnostic cutoff might receive a score of `0`, *does not meet diagnostic criteria*. However, in keeping with our characterization of the outcome in the simulated data employed in this book as desirable or beneficial, we may also imagine a situation in which `1` is assigned to sufficiently high levels of some desirable or beneficial outcome that exceed some threshold value, while scores below that value are assigned to be `0`. 

```{r}
#| fig-cap: "A Continuous Outcome Dichotomized"
#| fig-height: 3
#| label: fig-dichotomized
#| echo: false

library(ggplot2)

library(ggrepel)

N <- 100

outcome <-runif(N, 0, 100)

outcome_dichotomous <- ifelse(outcome > 50, 75, 25)

mydata <- data.frame(outcome, outcome_dichotomous)

ggplot(mydata) +
  geom_segment(aes(x = 0,
                   xend = 1,
                   y = outcome,
                   yend = outcome_dichotomous),
               color = "grey") +
  geom_point(aes(x = 0, y = outcome,
                 color = outcome)) +
  geom_point(aes(x = 1, 
                 y = outcome_dichotomous,
                 color = outcome_dichotomous),
             size = 7) +
  annotate("text", x = 1, 
           y = 25, 
           label = "0",
           color = "white") +
  annotate("text", x = 1, 
           y = 75, 
           label = "1",
           color = "white") +
  annotate("text", x = 1, 
           y = 50, 
           label = "dichotomous \noutcome",
           color = "black") +
  labs(title = "Continous Outcome Converted To Dichotomous Outcome",
       y = "continuous outcome") +
  xlim(0, 1.1) +
  theme_minimal() +
  theme(legend.position = "none")

```


Pedagogically, this new categorical outcome satisfies our need to have a dichotomous outcome to explain a new group of models--logistic regression models--that are suitable for such outcomes. It is sometimes considered to be a statistical rule of thumb that we should never dichotomize a continuous outcome. Certainly, it is true that when we dichotomize an outcome we lose a certain amount of information in the data about the variation, heterogeneity, or diversity in the outcome. Such a loss of information may reduce our ability to obtain statistically significant results. At the same time, certain numerical cutoffs may have important substantive meanings, clinical meanings, or policy meanings. For example I have already considered higher levels of anxiety or depression that may exceed clinically important cutoffs implying a diagnosis `1` versus `0` of depression or anxiety. Levels of income below a certain threshold--whether a country specific threshold or some globally relevant threshold--are considered to be in poverty[^povertyline], while individuals above that income threshold are considered to be not in poverty (`1` versus `0`). In the example considered in detail in this chapter, families with a child having a beneficial outcome at a certain level might be considered to have a child satisfying a certain minimal level of psychological well-being. 

In contrast, some outcomes are naturally dichotomous and do not arise from dichotomizing a continuous variable: born versus not born; married or partnered versus single; alive versus dead; entered a program; exited a program; conflict or protest occurred versus conflict or protest did not occur. 

## Two Strategies

I now consider two possible strategies from modeling dichotomous outcomes: the *linear multilevel model* that we have been considering so far in this book; and a *multilevel logistic regression* model designed specifically for dichotomous outcomes. The easiest way to consider and compare these models is through presentation.

```{r}
#| fig-cap: "Linear and Logistic Regression"
#| fig-height: 3
#| label: fig-linear-logistic
#| echo: false
#| message: false
#| warning: false

library(ggplot2)

library(patchwork)

N <- 100

x1 <- runif(N, -10, 10)

x2 <- runif(N, -10, 10)

beta1 <- 5

beta2 <- 1

z <- (beta1 * x1) + (beta2 * x2)

myprobability <- exp(z)/(1 + exp(z))

y <- ifelse(myprobability >= .5, 1, 0)

mydata <- data.frame(x1, myprobability, y)

p0 <- ggplot(mydata, 
             aes(x = x1, 
                 y = y)) +
  geom_point() +
  ylim(-.25, 1.25) +
  theme_minimal()
 
# p0 # replay

plinear <- p0 + 
  geom_smooth(method = "lm") +
  labs(title = "Linear Model")

plogistic <- p0 + 
  geom_smooth(method = "glm", 
              method.args = list(family = "binomial"),
              se = TRUE) +
  labs(title = "Logistic Model")

plinear + plogistic

```


In each model, the equivalent pattern of dots represents some dichotomous outcome (e.g. birth, death, satisfies diagnostic criterion) that becomes more likely as some independent variable increases in value. At higher levels of the independent variable, the outcome is almost exclusively `1`. at lower levels of the independent variable, the outcome is almost exclusively `0`. One could try to estimate this dichotomous outcome with a straight line, or linear model, as depicted in the left hand panel of figure XXX. This might be roughly plausible, and this procedure is termed a *linear probability model* which I will not discuss in more detail here. Suffice it to say that several problems emerge for a linear probability model: the model predicts values of the outcome greater than `1` and less than `0`; standard errors of the model are clearly not homoscedastic but change in value (heteroscedasticity); and lastly a linear model estimates a constant association between changes in *x* and changes in *y* when this is not appropriate. 

## Probabilities and Odds

To being to develop a *multilevel logistic regression* model, it is useful to think about ideas of *probabilities* and *odds*. One possible definition of a probability is that it is the long run fraction of times that an event occurs in series of events **CITATION**.  

For example, if there are 100 possible occasions for an event--for example, experiencing happiness--to occur, and happiness only occurs 10 times out of a possible 100, then we might say that the *probability* or *risk* of happiness is .10. If happiness occurs 90 times out of a possible 100 occurrences, then we would say that the *probability* or *risk* of happiness is .90. In contrast, if happiness occurs 10 times out of a possible 100, then the odds of happiness occurring are `10/90 = 1/9 = .11`. Similarly if happiness occurs 90 times, then the odds of happiness occurring are `90/10 = 9/1 = 9` [@Viera2008]. 

```{r}
#| tbl-cap: "Probabilities and Odds"
#| fig-height: 3
#| label: tbl-probabilities-odds
#| echo: false

`total occasions` <- rep(100, 10)

`event occurred` <- seq(10, 100, 10)

`event did not occur` <- `total occasions` - `event occurred`

risk <- `event occurred` / `total occasions`

odds <- `event occurred` / `event did not occur`

mydata <- data.frame(`total occasions`,
                     `event occurred`,
                     `event did not occur`,
                     risk,
                     odds,
                     check.names = FALSE)

pander::panderOptions('round',2)

pander::pander(mydata)

```


[^povertyline]: For example the World Bank [@WorldBankPovertyLine] considers $2.15 per person per day to be a globally relevant indicator of extreme poverty.


