# Multilevel Models in Stata, R and Julia

## Introduction

Below, I describe the use of Stata, R, and Julia to estimate multilevel models. Because this document is built by `quarto` I describe calling these programs from within a `quarto` environment. However, each piece of software could be used individually.

## The Data

The examples below use the `simulated_multilevel_data.dta` file.

## The Equation

$$\begin{gather} \text{outcome}_{ij}= \beta_0 + \beta_1 \text{warmth}_{ij} + \beta_2 \text{physical punishment}_{ij} + \\ \beta_3 \text{group}_{ij} + \beta_4 \text{HDI}_{ij} + \\ u_{0j} + u_{1j} \times \text{warmth} + e_{ij} \end{gather}$$ {#eq-MLMsubstantive}
   
## Setup 

::: {.panel-tabset}

### Stata

I need to use the library `Statamarkdown` to call Stata, or I could run Stata on its own

```{r}

library(Statamarkdown)

```

### R

In R, I use the library `lme4` to run multilevel models.

```{r}

library(lme4)

```

### Julia

I need to call Julia from R.

```{r}

library(JuliaCall)

julia_setup(JULIA_HOME = "/Applications/Julia-1.8.app/Contents/Resources/julia/bin")

```

:::

## Get Data & Run Models

To explain statistical syntax for each software, I consider the more general case of a multilevel model with dependent variable `y`, independent variables `x` and `z`, clustering variable `group`, and a random slope for `x`.

$$y = \beta_0 + \beta_1 x_{ij} + \beta_2 z_{ij} + u_0 + u_1j \times x + e_{ij}$$ {#eq-MLMsimple}

::: {.panel-tabset}

### Stata

In Stata, the syntax for a multilevel model of the form described in @eq-MLMsimple is:

`mixed y x || group: x`

```{stata}

use simulated_multilevel_data.dta

mixed outcome warmth physical_punishment group HDI || country: warmth

```

### R

In `lme4`, the general syntax for a multilevel model of the form described in @eq-MLMsimple is:

`lmer(y ~ x + z + (1 + x || group), data = ...)`

#### Get The Data

```{r}

library(haven)

df <- read_dta("simulated_multilevel_data.dta")

```

#### Run The Model

```{r}
#| warning: false

fit1 <- lmer(outcome ~ warmth + physical_punishment + 
               group + HDI +
               (1 + warmth || country),
             data = df)

summary(fit1)

```

### Julia

In Julia, the general syntax for a multilevel model of the form described in @eq-MLMsimple is:

`fit(MixedModel, @formula(y ~ x + z + (1 + x | group)), data)`

#### Load The Needed Packages And Load The Data

```{julia}
#| output: false

using Tables, MixedModels, StatFiles, DataFrames, CategoricalArrays, DataFramesMeta

df = DataFrame(load("simulated_multilevel_data.dta"))

```

#### Change Country To Categorical

```{julia}
#| output: false

@transform!(df, :country = categorical(:country))

```

#### Run The Model

```{julia}

m1 = fit(MixedModel, @formula(outcome ~ warmth + physical_punishment + 
               group + HDI +
               (1 + warmth | country)), df)

```

:::

